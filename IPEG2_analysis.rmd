---
title: "IPEG2_analysis"
author: "Bruce Peng"
date: "30/03/2020"
output: html_document
---

Here includes codes for analysis of IPEG2.

**Participants and trial numbers:**
A total of 30 participants are included in this dataset, each participants completed 40 trials thus the total number of trials is 40x30 = 1200. 34 trials were deleted due to participants' written responses did not conform to the task criteria. Thus, the total number of trials included in the analysis is 1152. 

**Data description:**
*participant:* N=30
*Sex:*: Participants' sex, Male or Female
*HS_ID*: Helping story presented during willingness to help rating on each trial
*Sim_SID:* Story presented to participants on each trial, a total of 40 stories were presented. These stories can be found in IPEG2_stimuli.xlsx
*STFace_ID*: Simulation target ID 
*ST_sex*: Sex of Simulation target (F=Female, M=Male). 
*ST_age*: Age group of Simulation target.
*HTFace_ID*: Helping target ID
*HT_sexr*: Helping target sex (Male or female)
*HT_age*: Helping target age (Old or young)
*story_conditions*: Helping story conditions  (0=not similar, 1= similar)
*Match*: Match of simulation and helping targets as well as helping and simulation story (1=Target and story mismatch, 2= Target match and story mismatch, 3= Target mismatch and story match, 4= Target and story mismatch)
*Trial:* Trial order presented to participants.
*Condition:* Imagine helping (Experimental:Imagine) and identify journalistic technique (Control:Identify)
*Detail:* "The imagined media website/scene in your mind was?" (collected for estimate and imagine helping conditions). Responses were made on a 1(simple)-7(detailed) Likert scale. 
*Coherence:* "The imagined media website/scene in your mind was?" (collected for estimate and imagine helping conditions). Responses were made on a 1(vague)-7(coherent and clear) Likert scale. 
*Perspective:*  "When you identified the media website, imagined helping, or visualized the media website and comments  did you consider  the thoughts and feelings of the person?" (collected for all conditions). Responses are made on a 1(not at all)- 7 (strongly considered). 
*Help:* DV of interest. "How likely would you be to help in this situation?" (collected for all conditions). Responses are made on a 1(not at all)- 7 (very willing) Likert scale.

Note: Detail, Coherence and Perspective are included so the proctocol mirrored previous studies as closely as possible and are not of particular interest in the current study. 

*Emotional reaction:*
Emotional reaction (collected for all conditions) rated on a 1(not at all)-7(very strongly) Likert scale for the following emotions:
-	Soft-hearted
-	Troubled 
-	Warm 
-	Distressed
-	Sympathetic
-	Compassionate
-	Disturbed
-	Tender
-	Moved
-	Worried
These measures are included to reduce the possibility of participants correctly guaging the experimental goal and are not utilized in the analyses


# Package and directory set up
```{r setup, include=FALSE}
# Load packages
if (!require(pacman)) install.packages('pacman')
pacman::p_load(tidyverse,brms, bayestestR) 

# Set working directory
setwd('C:/Users/dpen466/Google Drive/Phd (1)/Experiment/Studies/Data/IPE/IPEG/IPEG2/IPEG2_analysis/') #to change

# source custom codes
source("C:/Users/dpen466/Google Drive/Phd (1)/Experiment/Studies/Data/IPE/source/Bayes_scripts.R")
```

##Data setup

```{r}
# Loading data
IPEG2.df<- read.csv('IPEG2_fulldata_N=30.csv', header=T)

# Remove deleted trials from data frame
IPEG2.df<- IPEG2.df[complete.cases(IPEG2.df$Condition),]

# Convert Story_ID and Condition vectors into factors and ensure Identify condition is set as the reference group
IPEG2.df$Sim_SID<- as.factor(IPEG2.df$Sim_SID)
IPEG2.df$HS_ID<- as.factor(IPEG2.df$HS_ID)
IPEG2.df$Conditions<- as.factor(IPEG2.df$Conditions)
levels (IPEG2.df$Conditions) <- c('Identify', 'Imagine')

# Data transformations 
## Generate the five factor variable for Match conditions
IPEG2.df$Match_condition<- IPEG2.df$Match +1
IPEG2.df$Match_condition[IPEG2.df$Conditions=="Identify"] <- 1
IPEG2.df$Match_condition <- as.factor(IPEG2.df$Match_condition)
levels(IPEG2.df$Match_condition) <- c("Identify","HT-HS-", "HT+HS-","HT-HS+", "HT+HS+")

## Effect code and dummy
IPEG2.df<- IPEG2.df%>% 
              mutate(
                # Effect code sex of helping targets(Female=1, male=-1)
                HT_sex_c= ifelse(HT_sex=='F', 1, -1),
                # Effect code age of helping targets (1=Old, -1=Young)
                HT_age_c = ifelse(HT_age=='Old', 1, -1),
                # Create a dummy variable= for the condition variable
                dummy_img = as.numeric (Conditions=='Imagine'),
                # Ordered restricted contrast
                ORM_code = ifelse(Match_condition=='Identify', "Identify",
                                  ifelse(Match_condition=='HT+HS+','HT+HS+', "Imagine")))
IPEG2.df$ORM_code <- as.factor (IPEG2.df$ORM_code)
IPEG2.df$ORM_code <- relevel(IPEG2.df$ORM_code, ref = "Identify")
```


# Generalizability of Prosoical simulation effect
```{r}
Bayes<- brm(data=IPEG2.df, family=cumulative("logit"),
                      formula= bf(Help~Conditions+HT_sex_c+HT_age_c+(Conditions|participant)+
                      (Conditions|Sim_SID)+(Conditions|HTFace_ID)+(Conditions|STFace_ID)+(Conditions|HS_ID)) +
                   lf(disc~ 0+Conditions, cmc=F),
                  prior= c(prior(normal (0,1), class=b),
                           prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd),
                           prior(lkj(1), class = cor)),
                  iter=7000,warmup =2000, chains=8, cores=8, seed=20, sample_prior=T,save_all_pars = T, control=list(adapt_delta=0.99))

Bayes_gen<- brm(data=IPEG2.df, family=cumulative("logit"),
                      formula= bf(Help~Match_condition+HT_sex_c+HT_age_c+(Match_condition|participant)+
                      (Match_condition|Sim_SID)+(Match_condition|HTFace_ID)+(Match_condition|STFace_ID)+(1|HS_ID)) +
                   lf(disc~ 0+Match_condition, cmc=F),
                  prior= c(prior(normal (0,1), class=b),
                           prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd),
                           prior(lkj(1), class = cor)),
                  iter=7000,warmup =2000, chains=8, cores=8, seed=20, sample_prior=T,save_all_pars = T,control=list(adapt_delta=0.99))


# Diagnostic Checks: pp check and traceplots
pp_check(Bayes);plot(Bayes)
# Rhat and sample sizes
bayes_samples(Bayes)

# Prior Predictive simulations
set.seed(67);prior_sim(Bayes, c("sd_participant", 'cor_participant', "b"))

# Extract posterior samples 
set.seed(67)
posterior<- posterior_samples(Bayes) 
latent_SD(posterior)

# plot forest plot for the prosocial simulation effect 
forest.df<-as.data.frame(coef(Bayes)$participant[, ,1])
forest<- forest_plot(forest.df, c(0.37, 0.05, 0.70))
forest+ylab("Participants")+
      xlab ("Beta coefficients")

# Summary
summary(Bayes, prob=0.89)
# Evidence Ratios (not reported)
(ER<-hypothesis(Bayes, hypothesis =c("ConditionsImagine>0"),alpha=0.055, seed=67))
# pd
colMeans(ER$samples>0/4e4)
# % in ROPE
rope(ER$samples,ci=1, range = c(-0.1, 0.1))
# Plot the predicted probability of each category on the outcome measure for each condition
conditional_effects(Bayes,categorical=T)
# Plot the posterior probability and 95% credible intervals for the two main fixed effects of interest 
bayesplot::mcmc_areas(Bayes,pars = "b_ConditionsImagine",prob=0.90, prob_outer=0.95 , point_est="mean")
```


### Contrast the prosocial simulation effect across IPE, IPEF and IPEG
```{r}
IPE_imagine.df<-readRDS(file="IPE_Imagine.rds")
IPEF_imagine.df<-readRDS(file="IPEF_Imagine.rds")
IPEG_imagine.df<- readRDS(file="IPEG_Imagine.rds")

PSE<- cbind.data.frame('IPE'=IPE_imagine.df,
                       'IPEF'=IPEF_imagine.df,
                       'IPEG'=IPEG_imagine.df,
                       'IPEG2'= posterior$b_ConditionsImagine)
PSE.df<-PSE
PSE<- PSE %>% gather("IPE","IPEF", 'IPEG','IPEG2', key= Condition, value= Posterior)

violin_PSE<- violin_bayes(PSE)[[1]]
violin_PSE +
  labs(title="Prosocial simulation effect across experiments",x="Experiment", y = "Beta coefficient") +
  geom_hline(yintercept = c(-0.1, 0.1), color="blue", linetype='dashed') + 
  stat_boxplot(geom = "errorbar", width = 0.1, coef=0.7)
violin_bayes(PSE, CI_range = c(0.055, 0.945))[[2]]

# Existence and significance of PSE
p_direction(PSE.df)
rope(PSE.df,ci=1, range = c(-0.1, 0.1))
#-------------------------------------------------------------------------------------------------------------------------
# plot the contrast between them
IPE_IPEG2<-PSE$Posterior[PSE$Condition=="IPE"]-PSE$Posterior[PSE$Condition=="IPEG2"]
IPEF_IPEG2<-PSE$Posterior[PSE$Condition=="IPEF"]-PSE$Posterior[PSE$Condition=="IPEG2"]
IPE_IPEG<-PSE$Posterior[PSE$Condition=="IPE"]-PSE$Posterior[PSE$Condition=="IPEG"]
IPEF_IPEG<-PSE$Posterior[PSE$Condition=="IPEF"]-PSE$Posterior[PSE$Condition=="IPEG"]
IPEG_IPEG2 <- PSE$Posterior[PSE$Condition=="IPEG"]-PSE$Posterior[PSE$Condition=="IPEG2"]

PSE_dif<- cbind.data.frame("IPE-IPEG"=IPE_IPEG,
                          "IPEF-IPEG"=IPEF_IPEG,
                          "IPE-IPEG2"=IPE_IPEG2,
                          "IPEF-IPEG2"=IPEF_IPEG2, 
                          "IPEG-IPEG2"=IPEG_IPEG2)
PSE_dif.df<-PSE_dif
PSE_dif<- PSE_dif %>% gather("IPE-IPEG","IPEF-IPEG","IPE-IPEG2","IPEF-IPEG2","IPEG-IPEG2", key= Condition, value= Posterior)

violin_dif<- violin_bayes(PSE_dif)[[1]]
violin_dif +
  labs(title="Contrast of Prosocial simulation effect across experiments",x="Contrast", y = "Beta coefficient") +
  geom_hline(yintercept = c(-0.1, 0.1), color="blue", linetype='dashed') + 
  stat_boxplot(geom = "errorbar", width = 0.1, coef=0.7)
violin_bayes(PSE_dif, CI_range = c(0.055, 0.945))[[2]]

p_direction(PSE_dif.df)
rope(PSE_dif.df,ci=1, range = c(-0.1, 0.1))
```


# Grading effect of prosocial simulation effect 
```{r}
Bayes_gen<- brm(data=IPEG2.df, family=cumulative("logit"),
                      formula= bf(Help~Match_condition+HT_sex_c+HT_age_c+(Match_condition|participant)+
                      (Match_condition|Sim_SID)+(Match_condition|HTFace_ID)+(Match_condition|STFace_ID)+(1|HS_ID)) +
                   lf(disc~ 0+Match_condition, cmc=F),
                  prior= c(prior(normal (0,1), class=b),
                           prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd),
                           prior(lkj(1), class = cor)),
                  iter=7000,warmup =2000, chains=8, cores=8, seed=20, sample_prior=T,save_all_pars = T,control=list(adapt_delta=0.99))

# Diagnostic Checks
## Posterior prediction check- seems good
pp_check(Bayes_gen)
## MCMC plots - all seems to be nicely sampled
plot(Bayes_gen)
## Posterior probability for each parameter
mcmc_plot (Bayes_gen)

# Prior Predictive simulations
set.seed(67)
prior_sim(Bayes_gen, c("sd_participant", 'cor_participant', "b"))

# Total number of Sample size and sample sizes for each parameter
Bayes_gen_sample<-bayes_samples(Bayes_gen)

# Results
summary(Bayes_gen, prob=0.89)


# Plot the predicted probability of each category on the outcome measure for each condition
conditional_effects(Bayes_gen,categorical=T)


p_direction(Bayes_gen, parameters = "b_Match_condition")
rope(Bayes_gen,ci=1, range = c(-0.1, 0.1),parameters = "b_Match_condition")

test<- hypothesis(Bayes_gen, hypothesis =c("Match_conditionHTMHSM -Match_conditionHTMHSP=0",
                                           "Match_conditionHTMHSM -Match_conditionHTPHSM=0",
                                           "Match_conditionHTMHSM -Match_conditionHTPHSP=0",
                                           "Match_conditionHTMHSP -Match_conditionHTPHSM=0",
                                           "Match_conditionHTMHSP -Match_conditionHTPHSP=0",
                                           "Match_conditionHTPHSM -Match_conditionHTPHSP=0" ) , alpha=0.025)
test;plot(test)



# Extract posterior samples 
set.seed(67)
posterior_gen<- posterior_samples(Bayes_gen) 
latent_SD(posterior_gen)
```

### Violn plots
```{r}
match_cond2<-posterior_gen$b_Match_conditionHTMHSM
match_cond3<-posterior_gen$b_Match_conditionHTPHSM
match_cond4<-posterior_gen$b_Match_conditionHTMHSP
match_cond5<-posterior_gen$b_Match_conditionHTPHSP
gen_effect<- cbind.data.frame("HT-HS-"= match_cond2,
                              "HT+HS-"= match_cond3,
                              "HT-HS+"= match_cond4,
                              "HT+HS+"= match_cond5)
gen_effect.df<-gen_effect
gen_effect<- gen_effect %>%gather("HT-HS-", "HT+HS-", "HT-HS+", "HT+HS+", key= Condition, value= Posterior)

violin_gen<- violin_bayes(gen_effect)[[1]]
violin_gen +
  labs(title="Grading effect of generalization",x="Condition", y = "Beta coefficient") +
  stat_boxplot(geom = "errorbar", width = 0.1, coef=0.7) + 
  geom_hline(yintercept=c(-0.1, 0.1),color="blue",linetype="dashed")
violin_bayes(gen_effect, CI_range=c(0.055, 0.945))[[2]]

test<- cbind.data.frame("HT-HS->HT+HS-"=match_cond2-match_cond3, 
                        "HT-HS->HT-HS+"=match_cond2-match_cond4, 
                        "HT-HS->HT+HS+"=match_cond2-match_cond5, 
                        "HT+HS->HT-HS+"=match_cond3-match_cond4,
                        "HT+HS->HT+HS+"=match_cond3-match_cond5,
                        "HT-HS+>HT+HS+"=match_cond4-match_cond5)
test2<-test%>%gather("HT-HS->HT+HS-","HT-HS->HT-HS+","HT-HS->HT+HS+","HT+HS->HT-HS+","HT+HS->HT+HS+","HT-HS+>HT+HS+",key= Condition, value= Posterior)
violin_test<- violin_bayes(test2)[[1]]
violin_test+
  labs(title="Contrasts between conditions",x="contrasts", y = "Beta coefficient") +
  stat_boxplot(geom = "errorbar", width = 0.1, coef=0.7) + 
  geom_hline(yintercept=c(-0.1, 0.1),color="blue",linetype="dashed")
point_estimate(test);p_direction (test)
rope(test,ci=1, range =c(-0.10, 0.10))
```




### Order restricted model
* Models to be compared
** 1) a null model M0: all conditions (including control) are ~ equal
** 2) Unrestricted model Mu1: Identify != HT-HS- = HT+HS- = HT-HS+ = HT+HS+
** 3) Unrestricted model Mu2: Identify != HT-HS- != HT+HS- != HT-HS+ != HT+HS+
** 4) Unrestricted model Mu3: Identify != HT-HS- = HT+HS- = HT-HS+ != HT+HS+
** 5) ordered model1 M1:  Identify < HT-HS- = HT+HS- = HT-HS+ = HT+HS+
** 6) ordered model2 (theory driven) M2: Identify < HT-HS- < HT+HS- = HT-HS+ < HT+HS+
** 7) ordered model3 (data driven) M3: Identify < HT-HS- = HT+HS- = HT-HS+ < HT+HS+

```{r}
# Null model 
null<- brm(data= IPEG.df, family=cumulative("logit"), 
                  Help~1+(1|participant)+
                      (1|Story_ID)+(1|HTFace_ID)+(1|STFace_ID)+(1|STFace_ID),
                  prior= c(prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd)), 
                  iter=7000,warmup=2000,chains=8, cores=8, seed=67, sample_prior=T, save_all_pars = T)

set.seed (67)
unrestricted <- bayes_factor(Bayes_gen, null)
unrestricted$bf

# set ROPE as 0.055
## Ordered Restricted model 1
restrictedmodel1<- (posterior_gen[, "b_Match_conditionSMAM"]>0) & 
  (posterior_gen[, "b_Match_conditionSMAP"]-posterior_gen[, "b_Match_conditionSMAM"]>0) &
  (abs(posterior_gen[, "b_Match_conditionSMAP"]-posterior_gen[, "b_Match_conditionSPAM"])<0.1) &
  (posterior_gen[, "b_Match_conditionSPAP"]-posterior_gen[, "b_Match_conditionSPAM"]>0)

(restrictedmodel1_BF<-restricted_BF(restrictedmodel1, 4e4, 5))

## Order restricted model 2
restrictedmodel2<-(posterior_gen[, "b_Match_conditionSMAM"]>0) & 
  (abs(posterior_gen[, "b_Match_conditionSMAM"]-posterior_gen[, "b_Match_conditionSPAM"])<0.1) &
  (posterior_gen[, "b_Match_conditionSMAP"]>posterior_gen[, "b_Match_conditionSPAM"]) &
  (abs(posterior_gen[, "b_Match_conditionSPAP"]-posterior_gen[, "b_Match_conditionSMAP"])<0.1)

(restrictedmodel2_BF<-restricted_BF(restrictedmodel2, 4e4, 5))

restricted2.vsrestricted1<-restricted2.vsunrestricted*(1/restricted1.vsunrestricted)
restricted2.vsrestricted1

test<-(abs(posterior_gen[, "b_Match_conditionSMAM"]-posterior_gen[, "b_Match_conditionSMAP"])<0.1) &
  (abs(posterior_gen[, "b_Match_conditionSMAP"]-posterior_gen[, "b_Match_conditionSPAM"])<0.1) &
  (abs(posterior_gen[, "b_Match_conditionSPAM"]-posterior_gen[, "b_Match_conditionSPAP"])<0.1)
(test_BF<-restricted_BF(test, 4e4, 5))


```


```{r}
# Mu1
Bayes<- brm(data=IPEG2.df, family=cumulative("logit"),
                      formula= bf(Help~Conditions+HT_sex_c+HT_age_c+(Conditions|participant)+
                      (Conditions|Sim_SID)+(Conditions|HTFace_ID)+(Conditions|STFace_ID)+(Conditions|HS_ID)) +
                   lf(disc~ 0+Conditions, cmc=F),
                  prior= c(prior(normal (0,1), class=b),
                           prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd),
                           prior(lkj(1), class = cor)),
                  iter=7000,warmup =2000, chains=8, cores=8, seed=20, sample_prior=T,save_all_pars = T, control=list(adapt_delta=0.99))

# Mu2
Bayes_gen<- brm(data=IPEG2.df, family=cumulative("logit"),
                      formula= bf(Help~Match_condition+HT_sex_c+HT_age_c+(Match_condition|participant)+
                      (Match_condition|Sim_SID)+(Match_condition|HTFace_ID)+(Match_condition|STFace_ID)+(1|HS_ID)) +
                   lf(disc~ 0+Match_condition, cmc=F),
                  prior= c(prior(normal (0,1), class=b),
                           prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd),
                           prior(lkj(1), class = cor)),
                  iter=7000,warmup =2000, chains=8, cores=8, seed=20, sample_prior=T,save_all_pars = T,control=list(adapt_delta=0.99))

# Mu3
Bayes_mu3<- brm(data=IPEG2.df, family=cumulative("logit"),
                      formula= bf(Help~ORM_code+HT_sex_c+HT_age_c+(ORM_code|participant)+
                      (ORM_code|Sim_SID)+(ORM_code|HTFace_ID)+(ORM_code|STFace_ID)+(1|HS_ID)) +
                   lf(disc~ 0+ORM_code, cmc=F),
                  prior= c(prior(normal (0,1), class=b),
                           prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd),
                           prior(lkj(1), class = cor)),
                  iter=7000,warmup =2000, chains=8, cores=8, seed=20, sample_prior=T,save_all_pars = T,control=list(adapt_delta=0.99))


# M0
null<- brm(data= IPEG.df, family=cumulative("logit"), 
                  Help~HT_sex_c+HT_age_c+(1|participant)+
                      (1|Story_ID)+(1|HTFace_ID)+(1|STFace_ID)+(1|STFace_ID),
                  prior= c(prior(normal(0,1.2), class=Intercept),
                           prior(exponential(1), class= sd)), 
                  iter=7000,warmup=2000,chains=8, cores=8, seed=67, sample_prior=T, save_all_pars = T)
```



























